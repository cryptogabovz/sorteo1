<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="fas fa-arrow-left me-2"></i>Dashboard Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/participants">Participantes</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <%= adminUsername || 'Admin' %>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="/admin/dashboard">Dashboard</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form method="POST" action="/admin/logout" class="d-inline">
                                    <button type="submit" class="dropdown-item">Cerrar Sesión</button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Información del Participante -->
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-user me-2" style="color: var(--brand-blue);"></i>
                            Detalles del Participante
                        </h4>
                        <span class="badge <%= participant.ticket_validated ? 'bg-success' : 'bg-danger' %> fs-6">
                            <%= participant.ticket_validated ? 'Validado' : 'Rechazado' %>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <label class="fw-bold">Nombre Completo:</label>
                                    <p class="mb-1"><%= participant.name %> <%= participant.last_name %></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <label class="fw-bold">Cédula:</label>
                                    <p class="mb-1"><%= participant.cedula %></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <label class="fw-bold">Teléfono:</label>
                                    <p class="mb-1"><%= participant.phone %></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <label class="fw-bold">Provincia:</label>
                                    <p class="mb-1"><%= participant.province %></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <label class="fw-bold">Total de Tickets:</label>
                                    <p class="mb-1"><span class="badge bg-info text-dark fs-6"><%= allTickets.length %> ticket<%= allTickets.length > 1 ? 's' : '' %></span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Tickets -->
                        <div class="tickets-list mt-4">
                            <h4 class="section-title">
                                <i class="fas fa-ticket-alt me-2" style="color: var(--brand-blue);"></i>
                                Todos los Tickets de este Participante
                            </h4>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Número de Ticket</th>
                                            <th>Fecha de Registro</th>
                                            <th>Estado</th>
                                            <th>Imagen</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% allTickets.forEach(ticket => { %>
                                            <tr <%= ticket.deleted_at ? 'class="table-secondary"' : '' %>>
                                                <td>
                                                    <% if (ticket.deleted_at) { %>
                                                        <span class="text-muted">
                                                            <em>Sin número asignado</em>
                                                            <br><small class="text-danger">(TICKET ELIMINADO)</small>
                                                        </span>
                                                    <% } else { %>
                                                        <strong class="text-primary">
                                                            #<%= ticket.ticket_number %>
                                                        </strong>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (ticket.deleted_at) { %>
                                                        <span class="text-muted">
                                                            <%= new Date(ticket.deleted_at).toLocaleDateString('es-ES', {
                                                                year: 'numeric',
                                                                month: 'short',
                                                                day: 'numeric',
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            }) %>
                                                        </span>
                                                        <br><small class="text-muted">Eliminado</small>
                                                    <% } else { %>
                                                        <%= new Date(ticket.created_at).toLocaleDateString('es-ES', {
                                                            year: 'numeric',
                                                            month: 'short',
                                                            day: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        }) %>
                                                        <br><small class="text-muted">
                                                            <%= new Date(ticket.created_at).toLocaleTimeString('es-ES', {
                                                                hour: '2-digit',
                                                                minute: '2-digit',
                                                                second: '2-digit'
                                                            }) %>
                                                        </small>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (ticket.deleted_at) { %>
                                                        <span class="badge bg-secondary">Eliminado</span>
                                                    <% } else if (ticket.ticket_validated) { %>
                                                        <span class="badge bg-success">Validado</span>
                                                    <% } else { %>
                                                        <span class="badge bg-danger">Rechazado</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (ticket.ticket_image_url && ticket.ticket_image_url.startsWith('/uploads/')) { %>
                                                        <button class="btn btn-sm btn-outline-secondary" onclick="openImageModal('<%= ticket.ticket_image_url %>')" title="Ver imagen del ticket">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                        <a href="<%= ticket.ticket_image_url %>" target="_blank" class="btn btn-sm btn-outline-primary ms-1" title="Abrir imagen en nueva pestaña">
                                                            <i class="fas fa-external-link-alt"></i>
                                                        </a>
                                                        <br><small class="text-muted">Imagen disponible</small>
                                                        <br><small class="text-info" style="font-size: 0.7rem;"><%= ticket.ticket_image_url %></small>
                                                    <% } else { %>
                                                        <span class="text-muted">Sin imagen</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (ticket.deleted_at) { %>
                                                        <span class="text-muted">
                                                            <i class="fas fa-info-circle" title="<%= ticket.deletion_reason %>"></i>
                                                            <small>Razón: <%= ticket.deletion_reason %></small>
                                                        </span>
                                                    <% } else { %>
                                                        <button class="btn btn-sm btn-outline-danger"
                                                                onclick="confirmDeleteTicket('<%= ticket.id %>', '<%= ticket.ticket_number %>')"
                                                                title="Eliminar este ticket">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    <% } %>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <% if (participant.validation_reason) { %>
                            <div class="mt-3">
                                <label class="fw-bold">Motivo de Validación:</label>
                                <div class="alert <%= participant.ticket_validated ? 'alert-success' : 'alert-danger' %>">
                                    <%= participant.validation_reason %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

           <!-- Acciones -->
           <div class="mt-4">
               <div class="d-flex justify-content-start">
                   <a href="/admin/participants" class="btn btn-outline-secondary">
                       <i class="fas fa-arrow-left me-2"></i>Volver a Participantes
                   </a>
               </div>
           </div>
        </div>
    </div>

    <!-- Modal para imagen completa -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Imagen del Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="Ticket" class="img-fluid" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <a id="downloadLink" href="" download class="btn btn-primary">
                        <i class="fas fa-download me-2"></i>Descargar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar ticket -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres eliminar el ticket <strong id="deleteTicketNumber"></strong>?</p>
                    <p class="text-danger"><strong>Esta acción no se puede deshacer.</strong></p>
                    <div class="mb-3">
                        <label for="deleteReason" class="form-label">
                            <strong>Razón de eliminación <span class="text-danger">*</span></strong>
                        </label>
                        <textarea
                            class="form-control"
                            id="deleteReason"
                            rows="3"
                            placeholder="Describe la razón por la que se elimina este ticket..."
                            required
                        ></textarea>
                        <div class="form-text">
                            Esta información será visible en el historial del participante.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-2"></i>Eliminar Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function openImageModal(imageSrc) {
            console.log('Abriendo modal con imagen:', imageSrc);

            const modalImage = document.getElementById('modalImage');
            const downloadLink = document.getElementById('downloadLink');

            // Limpiar imagen anterior
            modalImage.src = '';
            modalImage.onerror = function() {
                console.error('Error cargando imagen:', imageSrc);
                alert('Error al cargar la imagen. La imagen puede no existir o estar corrupta.');
                modal.hide();
            };

            modalImage.onload = function() {
                console.log('Imagen cargada exitosamente');
            };

            // Establecer nueva imagen
            modalImage.src = imageSrc;
            downloadLink.href = imageSrc;

            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        function confirmDeleteTicket(ticketId, ticketNumber) {
            // Mostrar modal de confirmación
            document.getElementById('deleteTicketNumber').textContent = ticketNumber;
            document.getElementById('deleteReason').value = ''; // Limpiar campo

            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();

            // Configurar el botón de confirmación
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.onclick = () => performDelete(ticketId, ticketNumber);
        }

        async function performDelete(ticketId, ticketNumber) {
            const reason = document.getElementById('deleteReason').value.trim();

            if (!reason) {
                alert('Por favor, ingresa una razón para eliminar el ticket.');
                return;
            }

            // Deshabilitar botón mientras procesa
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...';

            try {
                const response = await fetch(`/admin/participants/${ticketId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reason: reason })
                });

                const result = await response.json();

                if (result.success) {
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    modal.hide();

                    alert(`Ticket ${ticketNumber} eliminado exitosamente`);
                    location.reload(); // Recargar la página para actualizar la lista
                } else {
                    alert('Error al eliminar el ticket: ' + result.message);
                    // Re-habilitar botón
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Eliminar Ticket';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el ticket. Inténtalo de nuevo.');
                // Re-habilitar botón
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Eliminar Ticket';
            }
        }
    </script>
</body>
</html>